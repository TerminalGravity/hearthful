generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id          String       @id
  email       String       @unique
  displayName String?
  avatarUrl   String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  preferences Json?
  events      Event[]      @relation("EventHost")
  gameCreated Game[]
  mealCreated Meal[]
  photoAlbums PhotoAlbum[]
  rsvps       RSVP[]
}

model Family {
  id           String         @id @default(cuid())
  name         String
  description  String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  events       Event[]
  members      FamilyMember[]
  games        Game[]
  meals        Meal[]
  photoAlbums  PhotoAlbum[]
  subscription Subscription?
}

model FamilyMember {
  id          String   @id @default(cuid())
  userId      String
  name        String
  email       String
  familyId    String
  role        Role     @default(MEMBER)
  joinedAt    DateTime @default(now())
  preferences Json?
  family      Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  events      Event[]  @relation("EventParticipants")

  @@unique([userId, familyId])
  @@index([email])
}

model Event {
  id           String         @id @default(cuid())
  description  String?
  familyId     String
  hostId       String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  date         DateTime
  details      Json?
  name         String
  type         String
  family       Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  host         User           @relation("EventHost", fields: [hostId], references: [id])
  photos       Photo[]
  rsvps        RSVP[]
  participants FamilyMember[] @relation("EventParticipants")
  games        Game[]         @relation("EventToGame")
  meals        Meal[]         @relation("EventToMeal")
}

model RSVP {
  id        String     @id @default(cuid())
  userId    String
  eventId   String
  status    RSVPStatus
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  event     Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
}

model Meal {
  id           String   @id @default(cuid())
  name         String
  description  String?
  ingredients  String[]
  instructions String?
  category     String?
  familyId     String
  createdById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  createdBy    User     @relation(fields: [createdById], references: [id])
  family       Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  events       Event[]  @relation("EventToMeal")
}

model Game {
  id           String   @id @default(cuid())
  name         String
  description  String?
  instructions String?
  minPlayers   Int?
  maxPlayers   Int?
  ageRange     String?
  category     String?
  familyId     String
  createdById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  createdBy    User     @relation(fields: [createdById], references: [id])
  family       Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  events       Event[]  @relation("EventToGame")
}

model Photo {
  id          String      @id @default(cuid())
  url         String
  caption     String?
  eventId     String?
  uploadedAt  DateTime    @default(now())
  albumId     String?
  contentType String
  s3Key       String      @unique
  size        Int
  album       PhotoAlbum? @relation(fields: [albumId], references: [id], onDelete: Cascade)
  event       Event?      @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

model UserPreference {
  id             String   @id @default(cuid())
  userId         String   @unique
  displayName    String?
  email          String?
  theme          String   @default("system")
  language       String   @default("en")
  emailFrequency String   @default("daily")
  eventsUpdates  Boolean  @default(true)
  photosUpdates  Boolean  @default(true)
  mealsUpdates   Boolean  @default(true)
  gamesUpdates   Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Subscription {
  id                     String             @id @default(cuid())
  familyId               String             @unique
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  status                 SubscriptionStatus @default(INACTIVE)
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  family                 Family             @relation(fields: [familyId], references: [id], onDelete: Cascade)
}

model PhotoAlbum {
  id          String   @id @default(cuid())
  name        String
  description String?
  familyId    String
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  photos      Photo[]
  createdBy   User     @relation(fields: [createdById], references: [id])
  family      Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
}

enum Role {
  ADMIN
  MEMBER
}

enum RSVPStatus {
  YES
  NO
  MAYBE
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  TRIALING
}
